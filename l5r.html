
<div class="container">
  <div class="menu">
    <div class="logo"></div>
    <div class="menuMain">
      <label>
        <input name="attr_activeTab" value="1" type="radio" checked><span title="Personnage"></span>
      </label>
      <label>
        <input name="attr_activeTab" value="2" type="radio"><span title="Compétences"></span>
      </label>
      <label>
        <input name="attr_activeTab" value="3" type="radio"><span title="Combat"></span>
      </label>
      <label>
        <input name="attr_activeTab" value="4" type="radio"><span title="(Dés) Avantages"></span>
      </label>
      <label>
        <input name="attr_activeTab" value="5" type="radio"><span title="École &amp; Techniques"></span>
      </label>
      <label>
        <input name="attr_activeTab" value="6" type="radio"><span title="Magie"></span>
      </label>
      <label>
        <input name="attr_activeTab" value="7" type="radio"><span title="Histoire &amp; Relations"></span>
      </label>
      <label>
        <input name="attr_activeTab" value="8" type="radio"><span title="Outremonde"></span>
      </label>
    </div>
    <div class="menuFooter">
      <label>
        <input name="attr_activeTab" value="0" type="radio"><span title="Configuration"></span>
      </label><span>&copy; Calmacil 2022</span>
    </div>
  </div>
  <div class="main-container">
    <div class="dicebox">
      <div class="col3">
        <h3>Explose sur...</h3>
        <div class="explodeOnWrapper">
          <label>
            <input name="attr_explodeOn" value="0" type="radio"><span title="-"></span>
          </label>
          <label>
            <input name="attr_explodeOn" value="7" type="radio"><span title="7"></span>
          </label>
          <label>
            <input name="attr_explodeOn" value="8" type="radio"><span title="8"></span>
          </label>
          <label>
            <input name="attr_explodeOn" value="9" type="radio"><span title="9"></span>
          </label>
          <label>
            <input name="attr_explodeOn" value="10" type="radio" checked><span title="10"></span>
          </label>
        </div>
      </div>
      <div class="col3">
        <label>
          <input name="attr_hasFocus" value="1" type="checkbox"><span>Spécialité</span>
        </label>
        <label>
          <input name="attr_askDiff" value="1" type="checkbox"><span>Demander diff?</span>
        </label>
      </div>
      <div class="col3">
        <label for="rollMod"><span>Jet/Modif. ?</span>
          <input name="attr_rollMod" type="text" value="" id="rollMod">
        </label><span>Jet libre
          <button name="act_freeRoll" type="action" value=""></button></span>
      </div>
    </div>
    <input name="attr_activeTab" type="hidden" value="1">
    <div class="tab tab1">
      <div class="col2T1" id="identity">
        <label for="character_name"><span>Nom:</span>
          <input name="attr_character_name" type="text" value="" id="character_name">
        </label>
        <label for="clan"><span>Clan:</span>
          <input name="attr_clan" type="text" value="" id="clan">
        </label>
        <label for="family"><span>Famille:</span>
          <input name="attr_family" type="text" value="" id="family">
        </label>
        <label for="genre"><span>Genre:</span>
          <input name="attr_genre" type="text" value="" id="genre">
        </label>
        <label for="age"><span>Âge:</span>
          <input name="attr_age" type="text" value="" id="age">
        </label>
          <div class="caracbar" id="caracs">
            <div class="elem">
              <label for="constitution"><span>Consti.
                  <button name="act_constitution" type="action" value="constitution,Constitution"></button></span>
                <input name="attr_constitution" type="number" value="2" id="constitution">
              </label>
              <label for="earth"><span>Terre
                  <button name="act_earth" type="action" value="earth,Terre"></button></span>
                <input name="attr_earth" type="number" value="2" id="earth" readonly>
              </label>
              <label for="will"><span>Volonté
                  <button name="act_will" type="action" value="will,Volonté"></button></span>
                <input name="attr_will" type="number" value="2" id="will">
              </label>
            </div>
            <div class="elem">
              <label for="reflex"><span>Réflexes
                  <button name="act_reflex" type="action" value="reflex,Réflexes"></button></span>
                <input name="attr_reflex" type="number" value="2" id="reflex">
              </label>
              <label for="air"><span>Air
                  <button name="act_air" type="action" value="air,Air"></button></span>
                <input name="attr_air" type="number" value="2" id="air" readonly>
              </label>
              <label for="awareness"><span>Intuition
                  <button name="act_awareness" type="action" value="awareness,Intuition"></button></span>
                <input name="attr_awareness" type="number" value="2" id="awareness">
              </label>
            </div>
            <div class="elem">
              <label for="strength"><span>Force
                  <button name="act_strength" type="action" value="strength,Force"></button></span>
                <input name="attr_strength" type="number" value="2" id="strength">
              </label>
              <label for="water"><span>Eau
                  <button name="act_water" type="action" value="water,Eau"></button></span>
                <input name="attr_water" type="number" value="2" id="water" readonly>
              </label>
              <label for="perception"><span>Percep.
                  <button name="act_perception" type="action" value="perception,Perception"></button></span>
                <input name="attr_perception" type="number" value="2" id="perception">
              </label>
            </div>
            <div class="elem">
              <label for="agility"><span>Agilité
                  <button name="act_agility" type="action" value="agility,Agilité"></button></span>
                <input name="attr_agility" type="number" value="2" id="agility">
              </label>
              <label for="fire"><span>Feu
                  <button name="act_fire" type="action" value="fire,Feu"></button></span>
                <input name="attr_fire" type="number" value="2" id="fire" readonly>
              </label>
              <label for="intelligence"><span>Intel.
                  <button name="act_intelligence" type="action" value="intelligence,Intelligence"></button></span>
                <input name="attr_intelligence" type="number" value="2" id="intelligence">
              </label>
            </div>
            <div class="elem elemVoid">
              <label for="void"><span>Vide
                  <button name="act_void" type="action" value="void,Vide"></button></span>
                <input name="attr_void" type="number" value="2" id="void">
              </label>
              <label for="voidUsed"><span>Utilisé</span>
                <input name="attr_voidUsed" type="number" value="0" id="voidUsed">
              </label>
            </div>
          </div>
        <h3>Description</h3>
        <textarea name="attr_description">Description</textarea>
      </div>
      <div class="col3">
        <div class="xpbox">
          <label><span>XP. total</span>
            <input name="attr_xp_total" type="number" value="">
          </label>
          <input name="attr_xp_spent" type="hidden" value="">
          <label for="@{xp_total} - @{xp_spent}"><span>(Restant)</span>
            <input name="attr_xp_remain" type="number" value="" id="@{xp_total} - @{xp_spent}" readonly>
          </label>
          <label><span>Réputation</span>
            <input name="attr_insight" type="number" value="" readonly>
          </label>
          <label><span>(Rang)</span>
            <input name="attr_insight_rank" type="number" value="" readonly>
          </label>
        </div>
        <div class="honorbox">
          <label for="honor"><span>Honneur
              <button name="act_honor" type="action" value="honor,Honneur"></button></span>
            <input name="attr_honor" type="number" value="3.5" id="honor" min="0" max="10" step="0.1">
          </label>
          <label for="status"><span>Statut</span>
            <input name="attr_status" type="number" value="1.0" id="status" min="0" max="10" step="0.1">
          </label>
          <label for="glory"><span>Gloire</span>
            <input name="attr_glory" type="number" value="1.0" id="glory" min="0" max="10" step="0.1">
          </label>
          <label for="infamy"><span>Infamie</span>
            <input name="attr_infamy" type="number" value="0.0" id="infamy" min="0" max="10" step="0.1">
          </label>
          <label for="taint"><span>Souillure</span>
            <input name="attr_taint" type="number" value="0.0" id="taint" min="0" max="10" step="0.1">
          </label>
          <label for="shadow"><span>Ombre</span>
            <input name="attr_shadow" type="number" value="0.0" id="shadow" min="0" max="10" step="0.1">
          </label>
        </div>
      </div>
    </div>
    <div class="tab tab2">
        <div class="caracbar">
          <div class="elem">
            <label for="constitution"><span>Consti.
                <button name="act_constitution" type="action" value="constitution,Constitution"></button></span>
              <input name="attr_constitution" type="number" value="2" id="constitution">
            </label>
            <label for="earth"><span>Terre
                <button name="act_earth" type="action" value="earth,Terre"></button></span>
              <input name="attr_earth" type="number" value="2" id="earth" readonly>
            </label>
            <label for="will"><span>Volonté
                <button name="act_will" type="action" value="will,Volonté"></button></span>
              <input name="attr_will" type="number" value="2" id="will">
            </label>
          </div>
          <div class="elem">
            <label for="reflex"><span>Réflexes
                <button name="act_reflex" type="action" value="reflex,Réflexes"></button></span>
              <input name="attr_reflex" type="number" value="2" id="reflex">
            </label>
            <label for="air"><span>Air
                <button name="act_air" type="action" value="air,Air"></button></span>
              <input name="attr_air" type="number" value="2" id="air" readonly>
            </label>
            <label for="awareness"><span>Intuition
                <button name="act_awareness" type="action" value="awareness,Intuition"></button></span>
              <input name="attr_awareness" type="number" value="2" id="awareness">
            </label>
          </div>
          <div class="elem">
            <label for="strength"><span>Force
                <button name="act_strength" type="action" value="strength,Force"></button></span>
              <input name="attr_strength" type="number" value="2" id="strength">
            </label>
            <label for="water"><span>Eau
                <button name="act_water" type="action" value="water,Eau"></button></span>
              <input name="attr_water" type="number" value="2" id="water" readonly>
            </label>
            <label for="perception"><span>Percep.
                <button name="act_perception" type="action" value="perception,Perception"></button></span>
              <input name="attr_perception" type="number" value="2" id="perception">
            </label>
          </div>
          <div class="elem">
            <label for="agility"><span>Agilité
                <button name="act_agility" type="action" value="agility,Agilité"></button></span>
              <input name="attr_agility" type="number" value="2" id="agility">
            </label>
            <label for="fire"><span>Feu
                <button name="act_fire" type="action" value="fire,Feu"></button></span>
              <input name="attr_fire" type="number" value="2" id="fire" readonly>
            </label>
            <label for="intelligence"><span>Intel.
                <button name="act_intelligence" type="action" value="intelligence,Intelligence"></button></span>
              <input name="attr_intelligence" type="number" value="2" id="intelligence">
            </label>
          </div>
          <div class="elem elemVoid">
            <label for="void"><span>Vide
                <button name="act_void" type="action" value="void,Vide"></button></span>
              <input name="attr_void" type="number" value="2" id="void">
            </label>
            <label for="voidUsed"><span>Utilisé</span>
              <input name="attr_voidUsed" type="number" value="0" id="voidUsed">
            </label>
          </div>
        </div>
      <div class="skillsList"><span title="École">E.</span><span>Compétence</span><span>Spécialités</span><span>Trait</span><span>Rang</span><span>Jet</span>
        <fieldset class="repeating_skills">
          <label>
            <input name="attr_expand" value="1" type="checkbox"><span> </span>
          </label>
          <label>
            <input name="schoolSkill" type="checkbox"><span> </span>
          </label>
          <input name="attr_name" type="text" value="">
          <input name="attr_focus" type="text" value="">
          <select name="attr_trait">
            <option value="" selected></option>
            <option value="agility">Agilité</option>
            <option value="constitution">Constitution</option>
            <option value="strength">Force</option>
            <option value="intelligence">Intelligence</option>
            <option value="awareness">Intuition</option>
            <option value="perception">Perception</option>
            <option value="reflex">Réflexes</option>
            <option value="will">Volonté</option>
            <option value="void">Vide</option>
          </select>
          <input name="attr_rank" type="number" value="0" min="0" max="10">
          <input name="attr_roll" type="text" value="" readonly>
          <button name="act_skillroll" type="action" value=""></button>
          <input name="attr_expand" type="hidden" value="">
          <textarea name="attr_habilities" placeholder="Capacités de maîtrise, bonus..."></textarea>
        </fieldset>
      </div>
    </div>
    <div class="tab tab3">
      <div class="col2T1">
        <div class="col3" id="init">
          <h3>Initiative</h3>
          <label for="baseInit"><span>Base</span>
            <input name="attr_baseInit" type="text" value="" id="baseInit" readonly>
          </label>
          <label for="modInit"><span>Modificateurs</span>
            <input name="attr_modInit" type="text" value="" id="modInit">
          </label>
          <label for="totalInit"><span>Total</span>
            <input name="attr_totalInit" type="text" value="" id="totalInit" readonly>
          </label>
          <div><span>Rapide:</span>
            <button class="roll" name="roll_quickInit" type="roll" value="[[@{reflex} &{tracker:+}]]">
            </button>
          </div>
          <div><span>Initiative !</span>
            <button name="act_initRoll" type="action" value=""></button>
          </div>
          <h3>Récupération</h3>
          <label for="regenBase"><span>Récup. base</span>
            <input name="attr_regenBase" type="text" value="(@{constitution}*2+@{insight_rank})" id="regenBase" disabled>
          </label>
        </div>
        <div class="col3" id="movement">
          <h3>Mouvement</h3>
          <label for="freeMove"><span>Mvt. gratuit</span>
            <input name="attr_freeMove" type="text" value="" id="freeMove" readonly>
          </label>
          <label for="simpleMove"><span>Mvt. simple</span>
            <input name="attr_simpleMove" type="text" value="" id="simpleMove" readonly>
          </label>
          <label for="maxMove"><span>Max / round</span>
            <input name="attr_maxMove" type="text" value="" id="maxMove" readonly>
          </label>
          <label for="modMove"><span>Mod. Eau</span>
            <input name="attr_waterMod" type="number" value="0" id="modMove">
          </label>
          <h3>Défense</h3>
          <label for="baseDefense"><span>Déf. base</span>
            <input name="attr_baseDefense" type="number" value="" id="baseDefense" readonly>
          </label>
          <label for="fullDefense"><span>Déf. actuelle</span>
            <input name="attr_fullDefense" type="number" value="" id="fullDefense" readonly>
          </label>
        </div>
        <div class="col3" id="armor">
          <h3>Armure</h3>
          <label for="armorName"><span>Armure</span>
            <input name="attr_armorName" type="text" value="" id="armorName">
          </label>
          <label for="armorDef"><span>Def. bonus</span>
            <input name="attr_armorDef" type="number" value="" id="armorDef">
          </label>
          <label for="armorRed"><span>Réduction</span>
            <input name="attr_reduction" type="number" value="" id="armorRed">
          </label>
          <label for="armorMalus"><span>Malus Agi.</span>
            <input name="attr_armorMalus" type="number" value="" id="armorMalus">
          </label>
          <label>
            <input name="attr_armorEquipped" value="1" type="checkbox"><span>Équipé?</span>
          </label>
        </div>
      </div>
      <div class="col3" id="health">
        <h3> <span>Santé</span><span>
            <input name="attr_hp" type="number" value="">/
            <input name="attr_hp_max" type="number" value="" readonly>
            <input name="attr_woundmalus" type="hidden" value="0"></span></h3><span>Rang</span><span>Malus</span><span>Total</span>
        <fieldset class="repeating_health">
          <input name="attr_highlight" type="hidden" value="0">
          <input name="attr_rank" type="text" value="" readonly>
          <input name="attr_malus" type="text" value="" readonly>
          <input name="attr_total" type="number" value="" readonly>
        </fieldset>
      </div>
      <div class="col2" id="guard">
        <h3>Posture</h3>
      </div>
      <div class="col2" id="states">
        <h3>États</h3>
      </div>
      <div class="col2T1" id="weapons">
        <h3>Armes</h3><span>Arme</span><span>Compétence</span><span>B Atk</span><span>J Atk</span><span title="Spécialité">S</span><span title="Force max">F</span><span>Dégâts</span>
        <fieldset class="repeating_weapons">
          <label>
            <input name="attr_expand" value="1" type="checkbox"><span> </span>
          </label>
          <input name="attr_name" type="text" value="">
          <select name="attr_skill">
            <option value="" selected></option>
            <option value="chaine">Armes à chaînes</option>
            <option value="hast">Armes d'hast</option>
            <option value="lourd">Armes lourdes</option>
            <option value="naturel">Armes naturelles</option>
            <option value="baton">Bâtons</option>
            <option value="couteau">Couteaux</option>
            <option value="ventail">Éventails de guerre</option>
            <option value="kenjutsu">Kenjutsu</option>
            <option value="kyujutsu">Kyujutsu</option>
            <option value="lance">Lances</option>
            <option value="ninjutsu">Ninjutsu</option>
            <option value="iaijutsu">Iaijutsu</option>
            <option value="jiujutsu">Jiujutsu</option>
          </select>
          <input name="attr_attackbonus" type="text" value="0g0">
          <input name="attr_attack" type="text" value="0g0">
          <button name="act_attackroll" type="action" value=""></button>
          <label>
            <input name="attr_hasfocus" value="1" type="checkbox"><span> </span>
          </label>
          <input name="attr_maxstr" type="number" value="">
          <input name="attr_damage" type="text" value="0g0">
          <button name="act_damageroll" type="action" value=""></button>
          <input name="attr_expand" type="hidden" value="">
          <textarea name="attr_notes" placeholder="Notes"></textarea>
        </fieldset>
      </div>
      <div class="col3" id="inventory">
        <h3>Inventaire</h3><span>Objet</span><span title="Porté ?">P?</span>
        <fieldset class="repeating_inventory">
          <input name="attr_name" type="text" value="">
          <label>
            <input name="equipped" type="checkbox"><span> </span>
          </label>
        </fieldset>
      </div>
    </div>
    <div class="tab tab4">
      <h1>Avantages et désavantages</h1>
    </div>
    <div class="tab tab5">
      <h1>École et Techniques</h1>
    </div>
    <div class="tab tab6">
      <h1>Magie</h1>
    </div>
    <div class="tab tab7">
      <h1>Histoire et Relations</h1>
    </div>
    <div class="tab tab8">
      <h1>Outremonde</h1>
    </div>
    <div class="tab tab0">
      <h1>Configuration</h1>
    </div>
  </div>
</div>
<rolltemplate class="sheet-rolltemplate-base">
  <div class="sheet-header">
    <h1>{{charname}}</h1>
  </div>
  <div class="sheet-arrow-container">
    <div class="sheet-arrow-right"></div>
  </div>
  <div class="sheet-results">
    <h4>{{title}} : {{displayRoll}}</h4>
    <h4>Résultat: <span class="rollresult">{{roll}}</span></h4>
  </div>
</rolltemplate>
<script type="text/worker">
  /**
 * Creates a dice pool
 * @param {int} thrown Number of dice thrown
 * @param {int} kept Number of dice kept
 * @param {int} mod Numeric modificator
 * @returns a Pool object
 */
function createPool(thrown=0, kept=null, mod=0)
{
    return {
        thrown: parseInt(thrown)||0,
        kept: parseInt(kept === null ? thrown : kept)||0,
        mod: parseInt(mod)||0
    }
}

/**
 * Translate a XgY+Z roll string to a integer pool
 * @param {string} rollString The roll string
 * @returns Object(int, int, int)
 */
function parsePoolString(rollString)
{
    let regex = /(\d+)g(\d+)([+-]\d+)?/
    result = regex.exec(rollString)

    if (result === null) {
        return createPool(0, 0, rollString)
    }

    return createPool(result[1], result[2], result[3])
}

/**
 * 
 * @param {object} pool The pool
 * @returns The Roll and Keep pool string
 */
function poolToString(pool)
{
    try {
        let res = `${pool.thrown}g${pool.kept}`
        if (pool.mod > 0) {
            res += `+${pool.mod}`
        } else if (pool.mod < 0) {
            res += pool.mod
        }
        return res
    } catch (e) {
        console.error(e)
        return 'Error !'
    }
}

/**
 * Sums up any number of dice pools
 * @param  {...any} pools The list of pools
 * @returns A unified pool
 */
function sumPools(...pools)
{
    let sum = {thrown: 0, kept: 0, mod: 0}
    for (const pool of pools) {
        sum.thrown += pool.thrown
        sum.kept += pool.kept
        sum.mod += pool.mod
    }
    return sum
}

/**
 * Flattens a dice pool so that the number of dice never exceeds 10
 * @param {object} pool The initial pool
 * @returns The converted pool
 */
function flattenPool(pool)
{
    // thrown dice over 10 are converted to rolled dice (2 to 1)
    while (pool.kept < 10 && pool.thrown > 11) {
        pool.kept += 1
        pool.thrown -= 2
    }

    let overThrown = Math.max(pool.thrown - 10, 0)
    let overKept = Math.max(pool.kept - 10, 0)

    // remaining thrown dice over 10 are converted to bonus
    if (overThrown) {
        pool.thrown = 10;
        pool.mod += 2 * overThrown
    }

    // kept dice over 10 are converted to bonus
    if (overKept) {
        pool.kept = 10
        pool.mod += 2 * overKept
    }

    return pool
}

/**
 * Rolls a dice pool
 * @param {object} pool        The number of dice thrown
 * @param {string} title    The displayed roll title
 * @param {string} template The Rolltemplate ID
 */
function doRoll(pool, title, opts)
{
    opts = {
        ...{
            template: 'base',
            woundmalus: true,
            init: false,
            explodeOn: false
        },
        ...opts
    }
    console.warn(opts)
    pool = flattenPool(pool)
    var rollString = `&{template:${opts.template}} `

    getAttrs(['character_name', 'hasFocus', 'explodeOn', 'woundmalus'], function(v)
    {
        rollString += `{{charname=${v.character_name}}} `
        let expl = opts.explodeOn === false ? parseInt(v.explodeOn)||0 : parseInt(opts.explodeOn)||0
        
        rollString += `{{roll=[[{`
        for (let i = 0; i < pool.thrown; i++) {
            if (i) rollString += ', '
            rollString += `1d10`
            if (expl)
                rollString += `!>${expl}`
            if ("1" === v.hasFocus)
                rollString += `ro1`
        }
        rollString += `}k${pool.kept}+${pool.mod} `
        if (true === opts.woundmalus)
            rollString += `+ ${parseInt(v.woundmalus)||0} `
        if (true === opts.init)
            rollString += `&{tracker}`
        rollString +=`]]}} `

        rollString += `{{title=${title}}} `

        rollString += `{{displayRoll=${poolToString(pool)}}} `

        console.log(rollString)
        startRoll(rollString, function(result) {
            // Do stuff later
            finishRoll(result.rollId)
        })

    })
}

  function updateInsightRank()
{
    getAttrs(['insight'], function(v)
    {
        let insight = parseInt(v.insight)||0;
        let insight_rank = Math.max(Math.floor((insight - 100) / 25), 0)
        setAttrs({
            insight_rank: insight_rank
        })
    })
}

function updateInsight()
{
    getSectionIDs('skills', function(idarray)
    {
        let fields = ['earth', 'air', 'water', 'fire', 'void']
        idarray.forEach(id => fields.push(`repeating_skills_${id}_rank`))


        getAttrs(fields, function(v)
        {
            let r_earth = parseInt(v.earth)||0
            let r_air = parseInt(v.air)||0
            let r_water = parseInt(v.water)||0
            let r_fire = parseInt(v.fire)||0
            let r_void = parseInt(v.void)||0

            let insight = 10 * (r_air + r_earth + r_water + r_fire + r_void)
            idarray.forEach(id => {
                insight += parseInt(v[`repeating_skills_${id}_rank`])||0
            })
            setAttrs({
                insight: insight
            })
            updateInsightRank()
        })
    })
}function updateRings()
{
    getAttrs(['constitution', 'will', 'awareness', 'reflex', 'force', 'perception', 'agility', 'intelligence'], function(v)
    {
        setAttrs({
            earth: Math.min(v['constitution'], v['will']),
            air: Math.min(v['reflex'], v['awareness']),
            water: Math.min(v['force'], v['perception']),
            fire: Math.min(v['agility'], v['intelligence'])
        })
        updateInsight()
    })
}

on('change:constitution change:will change:awareness change:reflex change:force change:perception change:agility change:intelligence', v => {
    updateRings()
    updateAllSkills()
    updateAllAtkRolls()
});/**
 * Updates the roll value of a single skill
 * @param {string} rowId The ID of the skill row
 */
function updateSkill(rowId)
{
    let rowTrait = 'repeating_skills_' + rowId + '_trait'
    let rowRank = 'repeating_skills_' + rowId + '_rank'
    let rowRoll = 'repeating_skills_' + rowId + '_roll'

    getAttrs([rowTrait, rowRank, 'agility', 'awareness', 'constitution', 'intelligence', 'perception', 'reflex', 'strength', 'will', 'void'], (v) => {
        let rank = parseInt(v[rowRank])||0
        let traitValue = parseInt(v[v[rowTrait]])||0
        
        let roll = poolToString(flattenPool(createPool(traitValue + rank, traitValue)))
        let toSet = []
        toSet[rowRoll] = roll
        setAttrs(toSet)
    })
}

/**
 * Updates roll value of all skills
 */
function updateAllSkills()
{
    getSectionIDs('skills', (idarray) => {
        for (let i = 0; i < idarray.length; i++) {
            updateSkill(idarray[i])
        }
    })
}

on('change:repeating_skills:trait change:repeating_skills:rank', (evi) => {
    let rowId = evi.sourceAttribute.split('_')[2]
    updateSkill(rowId)
    updateInsight()
    updateAllAtkRolls()
});
  /**
 * Updates init attributes
 */
function updateInit()
{
    getAttrs(['insight_rank', 'reflex', 'modinit'], v => {
        let reflex = parseInt(v.reflex)||0
        let insight_rank = parseInt(v.insight_rank)||0

        let base_init = createPool(reflex + insight_rank, reflex)

        let modinit = parsePoolString(v.modinit)
        let total_init = sumPools(base_init, modinit)

        setAttrs({
            baseInit: flattenPool(poolToString(base_init)),
            totalInit: flattenPool(poolToString(total_init))
        })
    })
}

on('change:reflex change:modinit change:insight_rank', evi => {
    updateInit()
})

  /**
 * Computes the movement distances
 */
function computeMove()
{
    getAttrs(['water', 'waterMod'], v => {
        let water = parseInt(v.water)||0
        let waterMod = parseInt(v.waterMod)||0

        let factor = water + waterMod

        if (factor < 1) {
            factor = 1
        }

        setAttrs({
            freeMove: `${factor * 1.5} m`,
            simpleMove: `${factor * 3} m`,
            maxMove: `${factor * 6} m`
        })
    })
}

on('change:water change:waterMod', e => {
    computeMove()
})

  /**
 * Updates defenses stats
 */
function updateDefense() {
    getAttrs(['reflex', 'armorDef', 'armorEquipped'], v => {
        let reflex = parseInt(v.reflex)||0
        let armorDef = parseInt(v.armorDef)||0
        let isEquipped = parseInt(v.armorEquipped)||0

        let baseDef = 5 * (reflex + 2)
        let fullDef = baseDef

        if (isEquipped) {
            fullDef += armorDef
        }

        setAttrs({
            baseDefense: baseDef,
            fullDefense: fullDef
        })
    })
}

on('change:reflex change:armorDef change:armorEquipped', e => {
    updateDefense()
})

  var healthRows = []

/**
 * Adds a row to the health array
 * @param {int} idx The index in the table
 * @param {string} label The level's name
 * @param {string} malus Numeric wound mod to apply
 * @param {*} total Total HP at this row
 * @param {undefined} help Nothing for now
 */
function addHealthRow(idx, label, malus, total, help=undefined)
{
    let row = []
    row['label'] = label
    row['malus'] = malus
    row['total'] = total
    row['help'] = help
    row['id'] = generateRowID()
    healthRows[idx] = row
}

/**
 * Prepare the health array for standard human
 */
function prepareHealthRowStd()
{
    getAttrs(['earth'], v => {
        let earth = parseInt(v.earth)||0;
        let maxHp = earth*5
        let stdRow = earth*2

        addHealthRow(0, 'Indemne', '0', maxHp)
        addHealthRow(1, 'Égratigné', '-3', (maxHp += stdRow))
        addHealthRow(2, 'Légèrement blessé', '-5', (maxHp += stdRow))
        addHealthRow(3, 'Blessé', '-10', (maxHp += stdRow))
        addHealthRow(4, 'Gravement blessé', '-15', (maxHp += stdRow))
        addHealthRow(5, 'Impotent', '-20', (maxHp += stdRow))
        addHealthRow(6, 'Épuisé, Vide pour agir', '-40', (maxHp += stdRow))
        addHealthRow(7, 'Hors de combat', 'H/S', (maxHp += stdRow))

        setAttrs({
            hp_max: maxHp
        })
    })
}

/**
 * Empties the health monitor
 */
function clearHealthBlock()
{
    getSectionIDs('repeating_health', idarray => {
        for (var i = 0; i < idarray.length; i++)
        {
            removeRepeatingRow(`repeating_health_${idarray[i]}`)
        }
    })
}

function fillHealthRow(id, malus, total, highlight=0, label=undefined)
{
    let rankId = `repeating_health_${id}_rank`
    let malusId = `repeating_health_${id}_malus`
    let totalId = `repeating_health_${id}_total`
    let hlId = `repeating_health_${id}_highlight`

    let data = {}
    data[malusId] = malus
    data[totalId] = total
    data[hlId] = highlight
    if (label !== undefined)
        data[rankId] = label

    setAttrs(data)
}

/**
 * Fills the health monitor with the prepared rows and updates the wound level display
 */
function updateHealthMonitorDisplay()
{
    getAttrs(['hp', 'hp_max'], v => {
        var curtotal = 0
        let hp = parseInt(v.hp)||0
        let hp_max = parseInt(v.hp_max)||0
        let wounds = hp_max - hp
        for (var i = 0; i < healthRows.length; i++) {
            let id = healthRows[i].id
            let rowtotal = healthRows[i].total
            let rowmalus = healthRows[i].malus
            let hl = 0
            if (wounds >= curtotal && wounds < rowtotal) {
                hl = 1
                setAttrs({
                    woundmalus: parseInt(rowmalus)||0
                })
            } 
            curtotal = rowtotal

            fillHealthRow(id, rowmalus, rowtotal, hl, healthRows[i].label)
        }
    })
}

/**
 * Callback for events
 */
function prepareHealthRows()
{
    // Later add custom health
    clearHealthBlock()
    prepareHealthRowStd()
}

/**
 * Inflicts wounds taking the Reduction value into account
 * @param {int} oldHp the previous HP value
 * @param {int} newHp the new theoric HP value
 */
function woundsWithArmour(oldHp, newHp)
{
    getAttrs(['armorEquipped', 'reduction'], v => {
        let isEquipped = parseInt(v.armorEquipped)||0
        let reduction = parseInt(v.reduction)||0
        let trueHp = newHp

        if (oldHp > newHp && 1 === isEquipped) {
            trueHp += reduction
            if (trueHp > oldHp) trueHp = oldHp
        }
        setAttrs({
            hp: trueHp
        })
    })
}

on('change:hp', evi => {
    if (evi.sourceType === 'sheetworker') {
        woundsWithArmour(parseInt(evi.previousValue)||0, parseInt(evi.newValue)||0)
    }
    updateHealthMonitorDisplay()
})

  /**
 * Updates a single attack skill roll
 * @param {string} searchStringId Attribute ID to search for
 * @param {string} atkRollId The attack roll ID to update
 */
function fetchCombatSkillRoll(searchStringId, atkRollId) {
    var theTrait = 'agility'
    var toGet = ['agility', 'reflex', searchStringId];
    getSectionIDs('skills', idarray => {
        for (let i = 0; i < idarray.length; i++) {
            let id = idarray[i]
            let skillNameId = `repeating_skills_${id}_name`
            let skillRollId = 'repeating_skills_' + id + '_roll'
            toGet.push(skillNameId)
            toGet.push(skillRollId)

        }

        getAttrs(toGet, v => {
            let atkRoll = undefined
            for (let i = 0; i < idarray.length; i++) {
                let id = idarray[i]
                let skillNameId = `repeating_skills_${id}_name`
                let skillRollId = 'repeating_skills_' + id + '_roll'
                let skillName = v[skillNameId]
                let skillRoll = v[skillRollId]
                let searchString = v[searchStringId]
                if (searchString === 'kyujutsu') theTrait = 'reflex'

                if (skillName.toLowerCase().indexOf(searchString) > -1) {
                    atkRoll = skillRoll;
                }
            }

            if (atkRoll === undefined) {
                atkRoll = poolToString(createPool(v[theTrait]))
            }
            let data = {}
            data[atkRollId] = atkRoll

            setAttrs(data);
        })
    })
}

/**
 * Updates all attack rolls in the combat tab
 */
function updateAllAtkRolls() {
    getSectionIDs('weapons', idarray => {
        for(let i = 0; i < idarray.length; i++) {
            let wpnId = idarray[i]

            let wpnSearchstring = `repeating_weapons_${wpnId}_skill`
            let wpnAtkRollId = `repeating_weapons_${wpnId}_attack`

            fetchCombatSkillRoll(wpnSearchstring, wpnAtkRollId)
        }
    })
}

  on('clicked:freeRoll', function()
{
    getAttrs(['rollMod'], function(v){
        let pool = parsePoolString(v.rollMod)
        doRoll(pool, 'Jet libre')
        // TODO: see to set this last instruction configurable
        //setAttrs({rollMod: ''})
    })
})


on('clicked:constitution clicked:earth clicked:will clicked:reflex clicked:air clicked:awareness clicked:strength clicked:water clicked:perception clicked:agility clicked:fire clicked:intelligence clicked:void clicked:honor', function(e)
{
    let rolledAttribute = e.htmlAttributes.value.split(',')[0]
    let rollTitle = e.htmlAttributes.value.split(',')[1]
    getAttrs([rolledAttribute, 'rollMod'], function(v)
    {
        let pool = createPool(v[rolledAttribute])
        let rollMod = v['rollMod']
        let modPool = parsePoolString(rollMod)
        pool = sumPools(pool, modPool)
        doRoll(pool, rollTitle)
    })
});


on('clicked:repeating_skills:skillroll', function (e)
{
    let skillId = e.sourceAttribute.split('_')[2]
    let skillname = 'repeating_skills_' + skillId + '_name'
    let skillroll = 'repeating_skills_' + skillId + '_roll'
    getAttrs([skillroll, skillname, 'rollMod'], function(v) {
        let roll = v[skillroll]
        let name = v[skillname]
        let rollMod = v['rollMod']
        let pool = parsePoolString(roll)
        let modPool = parsePoolString(rollMod)
        pool = sumPools(pool, modPool)
        doRoll(pool, name)
    })
});

/**
 * Roll init
 */
on('clicked:initroll', function(e) {
    getAttrs(['totalinit', 'rollmod'], v => {
        let pool = parsePoolString(v.totalinit)
        let mod = parsePoolString(v.rollMod)
        pool = sumPools(pool, mod)
        doRoll(pool, 'Initiative !', {template:'base', woundmalus: false, init: true})
    })
});

/**
 * Roll attack
 */
on('clicked:repeating_weapons:attackroll', evi => {
    let wpnId = evi.sourceAttribute.split('_')[2]
    let atkName = `repeating_weapons_${wpnId}_name`
    let atkRoll = `repeating_weapons_${wpnId}_attack`
    let atkMod = `repeating_weapons_${wpnId}_attackbonus`
    getAttrs([atkName, atkMod, atkRoll, 'rollmod'], v => {
        let name = v[atkName]
        let pool = parsePoolString(v[atkRoll])
        let bonus = parsePoolString(v[atkMod])
        let mod = parsePoolString(v.rollmod)

        pool = sumPools(pool, bonus)
        pool = sumPools(pool, mod)

        doRoll(pool, name, {template: 'base'});
    })
})


on('clicked:repeating_weapons:damageroll', evi => {
    let wpnId = evi.sourceAttribute.split('_')[2]
    let dmgName = `repeating_weapons_${wpnId}_name`
    let dmgRoll = 'repeating_weapons_' + wpnId + '_damageroll'
    let dmgMaxstr = `repeating_weapons_${wpnId}_maxstr`
    getAttrs([dmgName, dmgName, dmgRoll, dmgMaxstr, 'rollmod', 'strength'], v => {
        let name = `Dégâts (${v[dmgName]})`
        let pool = parsePoolString(v[dmgRoll])
        let mod = parsePoolString(v.rollmod)
        let strength = parseInt(v.strength)||0
        let maxstr = parseInt(v[dmgMaxstr])||0

        if (maxstr > 0 && maxstr < strength) {
            strength = maxstr
        }

        pool = sumPools(pool, mod)
        pool = sumPools(pool, createPool(strength, 0))

        doRoll(pool, name, {explodeOn: 0})
    })
})

  on('sheet:opened', function()
{
    // remove when dev is finished
    console.clear()
    updateRings()
    updateAllSkills()
    updateInsight()
    updateInit()

    prepareHealthRows()
    updateHealthMonitorDisplay()
    computeMove()
    updateDefense()

    updateAllAtkRolls()
})
</script>