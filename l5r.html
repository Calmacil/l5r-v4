
<div class="container">
  <div class="menu">
    <div class="logo"></div>
    <div class="menuMain">
      <label>
        <input name="attr_activeTab" value="1" type="radio" checked><span title="Personnage"></span>
      </label>
      <label>
        <input name="attr_activeTab" value="2" type="radio"><span title="Compétences"></span>
      </label>
      <label>
        <input name="attr_activeTab" value="3" type="radio"><span title="Combat"></span>
      </label>
      <label>
        <input name="attr_activeTab" value="4" type="radio"><span title="(Dés) Avantages"></span>
      </label>
      <label>
        <input name="attr_activeTab" value="5" type="radio"><span title="École &amp; Techniques"></span>
      </label>
      <label>
        <input name="attr_activeTab" value="6" type="radio"><span title="Magie"></span>
      </label>
      <label>
        <input name="attr_activeTab" value="7" type="radio"><span title="Histoire &amp; Relations"></span>
      </label>
      <label>
        <input name="attr_activeTab" value="8" type="radio"><span title="Outremonde"></span>
      </label>
    </div>
    <div class="menuFooter">
      <label>
        <input name="attr_activeTab" value="0" type="radio"><span title="Configuration"></span>
      </label><span>&copy; Calmacil 2022</span>
    </div>
  </div>
  <div class="main-container">
    <div class="dicebox">
      <div class="col3">
        <h3>Explose sur...</h3>
        <div class="explodeOnWrapper">
          <label>
            <input name="attr_explodeOn" value="0" type="radio"><span title="-"></span>
          </label>
          <label>
            <input name="attr_explodeOn" value="7" type="radio"><span title="7"></span>
          </label>
          <label>
            <input name="attr_explodeOn" value="8" type="radio"><span title="8"></span>
          </label>
          <label>
            <input name="attr_explodeOn" value="9" type="radio"><span title="9"></span>
          </label>
          <label>
            <input name="attr_explodeOn" value="10" type="radio" checked><span title="10"></span>
          </label>
        </div>
      </div>
      <div class="col3">
        <label>
          <input name="attr_hasFocus" value="1" type="checkbox"><span>Spécialité</span>
        </label>
        <label>
          <input name="attr_askDiff" value="1" type="checkbox"><span>Demander diff?</span>
        </label>
      </div>
      <div class="col3">
        <label for="rollMod"><span>Jet/Modif. ?</span>
          <input name="attr_rollMod" type="text" value="" id="rollMod">
        </label><span>Jet libre
          <button name="act_freeRoll" type="action" value=""></button></span>
      </div>
    </div>
    <input name="attr_activeTab" type="hidden" value="1">
    <div class="tab tab1">
      <div class="col2T1" id="identity">
        <label for="character_name"><span>Nom:</span>
          <input name="attr_character_name" type="text" value="" id="character_name">
        </label>
        <label for="clan"><span>Clan:</span>
          <input name="attr_clan" type="text" value="" id="clan">
        </label>
        <label for="family"><span>Famille:</span>
          <input name="attr_family" type="text" value="" id="family">
        </label>
        <label for="genre"><span>Genre:</span>
          <input name="attr_genre" type="text" value="" id="genre">
        </label>
        <label for="age"><span>Âge:</span>
          <input name="attr_age" type="text" value="" id="age">
        </label>
          <div class="caracbar" id="caracs">
            <div class="elem">
              <label for="constitution"><span>Consti.
                  <button name="act_constitution" type="action" value="{{jet=[[@{constitution}d10k@{constitution}!10]]}}"></button></span>
                <input name="attr_constitution" type="number" value="2" id="constitution">
              </label>
              <label for="earth"><span>Terre</span>
                <input name="attr_earth" type="number" value="2" id="earth" readonly>
              </label>
              <label for="will"><span>Volonté</span>
                <input name="attr_will" type="number" value="2" id="will">
              </label>
            </div>
            <div class="elem">
              <label for="reflex"><span>Réflexes</span>
                <input name="attr_reflex" type="number" value="2" id="reflex">
              </label>
              <label for="air"><span>Air</span>
                <input name="attr_air" type="number" value="2" id="air" readonly>
              </label>
              <label for="awareness"><span>Intuition</span>
                <input name="attr_awareness" type="number" value="2" id="awareness">
              </label>
            </div>
            <div class="elem">
              <label for="strength"><span>Force</span>
                <input name="attr_strength" type="number" value="2" id="strength">
              </label>
              <label for="water"><span>Eau</span>
                <input name="attr_water" type="number" value="2" id="water" readonly>
              </label>
              <label for="perception"><span>Percep.</span>
                <input name="attr_perception" type="number" value="2" id="perception">
              </label>
            </div>
            <div class="elem">
              <label for="agility"><span>Agilité</span>
                <input name="attr_agility" type="number" value="2" id="agility">
              </label>
              <label for="fire"><span>Feu</span>
                <input name="attr_fire" type="number" value="2" id="fire" readonly>
              </label>
              <label for="intelligence"><span>Intel.</span>
                <input name="attr_intelligence" type="number" value="2" id="intelligence">
              </label>
            </div>
            <div class="elem elemVoid">
              <label for="void"><span>Vide</span>
                <input name="attr_void" type="number" value="2" id="void">
              </label>
              <label for="voidUsed"><span>Utilisé</span>
                <input name="attr_voidUsed" type="number" value="0" id="voidUsed">
              </label>
            </div>
          </div>
      </div>
      <div class="col3"><span>HonorBox</span></div>
    </div>
    <div class="tab tab2">
      <h1>Compétences</h1>
    </div>
    <div class="tab tab3">
      <h1>Combat</h1>
    </div>
    <div class="tab tab4">
      <h1>Avantages et désavantages</h1>
    </div>
    <div class="tab tab5">
      <h1>École et Techniques</h1>
    </div>
    <div class="tab tab6">
      <h1>Magie</h1>
    </div>
    <div class="tab tab7">
      <h1>Histoire et Relations</h1>
    </div>
    <div class="tab tab8">
      <h1>Outremonde</h1>
    </div>
    <div class="tab tab0">
      <h1>Configuration</h1>
    </div>
  </div>
</div>
<rolltemplate class="sheet-rolltemplate-base">
  <div class="sheet-header">
    <h1>{{charname}}</h1>
  </div>
  <div class="sheet-results">
    <h4>{{title}} : {{displayRoll}}</h4>
    <h4>{{roll}}</h4>
  </div>
</rolltemplate>
<script type="text/worker">
  on('sheet:opened change:constitution change:will change:awareness change:reflex change:force change:perception change:agility change:intelligence', function()
{
    getAttrs(['constitution', 'will', 'awareness', 'reflex', 'force', 'perception', 'agility', 'intelligence'], function(v)
    {
        setAttrs({
            earth: Math.min(v['constitution'], v['will']),
            air: Math.min(v['reflex'], v['awareness']),
            water: Math.min(v['force'], v['perception']),
            fire: Math.min(v['agility'], v['intelligence'])
        })
    })
});/**
 * Creates a dice pool
 * @param {int} thrown Number of dice thrown
 * @param {int} kept Number of dice kept
 * @param {int} mod Numeric modificator
 * @returns a Pool object
 */
function createPool(thrown=0, kept=null, mod=0)
{
    return {
        thrown: parseInt(thrown)||0,
        kept: parseInt(kept === null ? thrown : kept)||0,
        mod: parseInt(mod)||0
    }
}

/**
 * Translate a XgY+Z roll string to a integer pool
 * @param {string} rollString The roll string
 * @returns Object(int, int, int)
 */
function parsePoolString(rollString)
{
    let regex = /(\d+)g(\d+)([+-]\d+)?/
    result = regex.exec(rollString)

    if (result === null) {
        return createPool(0, 0, rollString)
    }

    return createPool(result[1], result[2], result[3])
}

function poolToString(pool)
{
    try {
        let res = `${pool.thrown}g${pool.kept}`
        if (pool.mod > 0) {
            rollString += `+${pool.mod}`
        } else if (pool.mod < 0) {
            rollString += pool.mod
        }
        return res
    } catch (e) {
        return 'Error !'
    }
}

/**
 * Sums up any number of dice pools
 * @param  {...any} pools The list of pools
 * @returns A unified pool
 */
function sumPools(...pools)
{
    let sum = {thrown: 0, kept: 0, mod: 0}
    for (const pool of pools) {
        sum.thrown += pool.thrown
        sum.kept += pool.kept
        sum.mod += pool.mod
    }
    return sum
}

function flattenPool(pool)
{
    // TODO later
}

/**
 * Rolls a dice pool
 * @param {int} pool        The number of dice thrown
 * @param {int} kept        The number of dice kept
 * @param {int} mod         A numeric modificator to the total result
 * @param {string} title    The displayed roll title
 * @param {string} template The Rolltemplate ID
 */
function doRoll(pool, title, template='base')
{
    var rollString = `&{template:${template}} `
    getAttrs(['character_name', 'hasFocus', 'explodeOn'], function(v)
    {
        rollString += `{{charname=${v.character_name}}} `

        rollString += `{{roll=[[{`
        for (let i = 0; i < pool.thrown; i++) {
            if (i) rollString += ', '
            rollString += `1d10`
            if (v.explodeOn)
                rollString += `!>${v.explodeOn}`
            if ("1" === v.hasFocus)
                rollString += `ro1`
        }
        rollString += `}k${pool.kept}+${pool.mod}]]}} `

        rollString += `{{title=${title}}} `

        rollString += `{{displayRoll=${poolToString(pool)}}} `

        startRoll(rollString, function(result) {
            // Do stuff later
            finishRoll(result.rollId)
        })

    })
}

on('clicked:constitution', function()
{
    console.log("COUCOU")
});

on('clicked:freeRoll', function()
{
    getAttrs(['rollMod'], function(v){
        let pool = parsePoolString(v.rollMod)
        doRoll(pool, 'Jet libre')
        // TODO: see to set this last instruction configurable
        setAttrs({rollMod: ''})
    })
})
</script>